# xv6-riscv README

## Overview

**xv6 is a complete, working command-line operating system** for RISC-V computers. It is a modern re-implementation of Dennis Ritchie and Ken Thompson's **Unix Version 6 (v6)**. It follows the original structure and design philosophy of v6 but is re-written in **ANSI C** for the **RISC-V multiprocessor architecture**. xv6 is widely used as an educational operating system in MIT's 6.1810 Operating Systems course.

### Complete Operating System Features

This project provides a **fully functional command-line operating system** with the following core components:

#### ğŸ–¥ï¸ **Command-Line Shell**
- Interactive shell (`sh.c`) with command parsing
- Supports command execution, redirection (`>`, `<`), and pipelines (`|`)
- Built-in commands: `cd`, `ls`, `cat`, `echo`, `grep`, `mkdir`, `rm`, `kill`, `sleep`, etc.

#### ğŸ“ **File System**
- Complete inode-based file system with journaling
- Supports regular files, directories, and device files
- File operations: create, read, write, delete, link, unlink
- Directory navigation and management

#### ğŸ”„ **Process Management**
- Multi-process support with `fork()`, `exec()`, `wait()`, `exit()`
- Round-robin scheduling across multiple CPU cores
- Process synchronization and inter-process communication

#### ğŸ’¾ **Memory Management**
- RISC-V Sv39 paging with virtual memory
- Separate kernel and user address spaces
- Page allocation and management

#### ğŸ”§ **System Calls**
- Complete system call interface (20+ system calls)
- User-kernel mode switching via RISC-V `ecall` instruction
- System calls for file operations, process management, and synchronization

#### ğŸ†• **New Feature: Semaphore Synchronization**
This customized version **extends** the base xv6 with **semaphore synchronization primitives** and includes demonstration programs to verify inter-process communication and synchronization.

---

## New Features in This Project

### ğŸ§© Semaphore System Calls

Newly implemented system calls for process synchronization:

| System Call           | Description                                 |
| --------------------- | ------------------------------------------- |
| `sem_init(int value)` | Initialize a semaphore with a given count   |
| `sem_wait(int id)`    | Wait (decrement), block if value <= 0       |
| `sem_post(int id)`    | Signal (increment), wake up waiting process |
| `sem_free(int id)`    | Free a semaphore and release resources      |

* Implemented in: `kernel/semaphore.c`
* Kernel linkage through: `sysproc.c`, `syscall.c`, `syscall.h`
* User-level interface: `user/semtest.c`, `user/prodcons.c`

---

## Demonstration Programs

### 1. **semtest.c**

A simple parent-child synchronization test:

* The child waits using `sem_wait()`.
* The parent releases it using `sem_post()`.

Expected Output:

```
Parent: waiting on semaphore...
Child: semaphore acquired!
```

### 2. **prodcons.c**

Implements the **Producer-Consumer problem** using semaphores:

* Ensures mutual exclusion and synchronization.
* Demonstrates inter-process communication.

Expected Output:

```
Producer: produced item 1
Consumer: consumed item 1
Producer finished!
Consumer finished!
All items processed!
```

---

## xv6 System Architecture Summary

For detailed system design and subsystem descriptions, refer to the accompanying documentation:
ğŸ“„ `System_Architecture.md`

Covers:

* Boot and initialization sequence
* Process scheduling (Round Robin)
* Memory management (Sv39 paging)
* File system structure (inode + journaling)
* System call mechanism and semaphore synchronization

---

## Build and Run Instructions

### 1. Install Dependencies (macOS / Linux)

```bash
brew install qemu riscv-tools
```

### 2. Build xv6 for RISC-V

```bash
make TOOLPREFIX=riscv64-unknown-elf-
```

### 3. Run xv6 in QEMU

```bash
make qemu TOOLPREFIX=riscv64-unknown-elf-
```

### 4. Inside xv6 Shell

Once xv6 boots, you'll see the command prompt `$`. This is a **fully functional command-line operating system**. You can use standard Unix commands:

**Basic Commands:**
```bash
$ ls              # List files
$ cat README      # Display file contents
$ echo hello      # Print text
$ mkdir test      # Create directory
$ rm file         # Delete file
$ grep pattern file  # Search in files
```

**Run Multiple Programs:**
```bash
$ sleep 10 &      # Run in background
$ forktest        # Test fork functionality
```

**Use Shell Features:**
```bash
$ echo hello | grep hello    # Pipeline
$ ls > output.txt            # Redirection
$ cat file1 file2            # Multiple arguments
```

**Test Semaphore Features (New):**
```bash
$ semtest         # Test semaphore synchronization
$ prodcons        # Test producer-consumer problem
```

**Exit the Shell:**
Press `Ctrl+A` then `X` to exit QEMU (xv6 shell doesn't have built-in `exit` command)

---

## Acknowledgments

xv6 is based on the work of:

* Dennis Ritchie and Ken Thompson (original Unix v6)
* MIT CSAIL PDOS group: Russ Cox, Frans Kaashoek, and Robert Morris

See the original xv6 distribution and documentation at:
ğŸ‘‰ [https://pdos.csail.mit.edu/6.1810/](https://pdos.csail.mit.edu/6.1810/)

---

## AI Tool Usage and Prompts

This project was developed with assistance from AI tools (ChatGPT EDU and Cursor AI). Below are the actual prompts used during development, organized by category.

### Environment Setup and Installation

1. **macOS RISC-V Toolchain Installation**
   - "æˆ‘ç”¨çš„æ˜¯ macOSï¼Œé‡æ–°æŒ‡å¯¼æˆ‘æ€ä¹ˆå®‰è£… riscv64-unknown-elf å·¥å…·é“¾ã€‚"

2. **Xcode Command Line Tools**
   - "brew install gcc æŠ¥é”™éœ€è¦ Xcode Command Line Toolsï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ"

### Build System and Makefile Issues

3. **Makefile Syntax Errors**
   - "ä¸ºä»€ä¹ˆæˆ‘è¿è¡Œ make æŠ¥é”™ 'commands commence before first target'ï¼Ÿ"
   - "ä¸ºä»€ä¹ˆ make qemu æ€»æ˜¯å¤±è´¥ï¼Ÿå¯èƒ½åŸå› æœ‰å“ªäº›"
   - "ä¸ºä»€ä¹ˆ make ä¼šæç¤º missing separatorï¼Ÿ"

4. **File Path and Location**
   - "ä¸ºä»€ä¹ˆ exec è¿è¡Œ sleep å¤±è´¥ï¼Ÿsleep.c åº”è¯¥æ”¾åœ¨å“ªï¼Ÿ"
   - "ä¸ºä»€ä¹ˆ semtest æ— æ³•æ‰§è¡Œï¼Ÿæˆ‘å·²ç»åŠ è¿› Makefile äº†ã€‚"

### System Usage

5. **QEMU and Shell Navigation**
   - "æˆ‘æ€ä¹ˆé€€å‡º xv6 shellï¼Ÿæ€ä¹ˆå›åˆ° macOS ç»ˆç«¯ï¼Ÿ"

### Code Implementation and Debugging

6. **System Call Implementation**
   - "æ·»åŠ ç³»ç»Ÿè°ƒç”¨éœ€è¦ä¿®æ”¹å“ªäº›æ–‡ä»¶ï¼Ÿè¯·ä¸€æ­¥æ­¥å‘Šè¯‰æˆ‘ã€‚"
   - "ä¸ºä»€ä¹ˆ sys_sleep é‡å¤å®šä¹‰ï¼Ÿsyscall.c å’Œ sysproc.c ä»£ç åº”è¯¥å¦‚ä½•æ‹†åˆ†ï¼Ÿ"
   - "ä¸ºä»€ä¹ˆå‡ºç° multiple definition of fetchstr / fetchaddr é”™è¯¯ï¼Ÿ"
   - "ä¸ºä»€ä¹ˆ syscalls[] ä¼šè¶Šç•Œï¼Ÿç¼–å·åº”è¯¥æ€ä¹ˆå®‰æ’ï¼Ÿ"
   - "sem_init / sem_wait / sem_post / sem_free æ”¾åœ¨ syscall.c è¿˜æ˜¯ sysproc.cï¼Ÿ"

7. **Semaphore Implementation**
   - "ä¸ºä»€ä¹ˆ semtest æ˜¾ç¤º unknown sys callï¼Ÿ"
   - "ä¸ºä»€ä¹ˆ semaphore_wait è¦ç”¨ while å¾ªç¯ï¼Ÿsleep å’Œ wakeup å¦‚ä½•æ­£ç¡®é…åˆï¼Ÿ"
   - "å¦‚ä½•åœ¨ xv6 ä¸­å®ç°ä¸€ä¸ªæ­£ç¡®é˜»å¡çš„ semaphore_waitï¼Ÿ"

8. **Program Output and Behavior**
   - "ä¸ºä»€ä¹ˆ semtest è¾“å‡ºä¹±ç ï¼Ÿæ˜¯ä¸æ˜¯ printf æˆ–ç”¨æˆ·ç¨‹åºæœ‰é—®é¢˜ï¼Ÿ"
   - "ä¸ºä»€ä¹ˆ prodcons è¾“å‡ºé¡ºåºä¸å›ºå®šï¼Ÿè¿™æ˜¯æ­£å¸¸çš„å—ï¼Ÿ"

9. **Producer-Consumer Implementation**
   - "prodcons.c åº”è¯¥æ€ä¹ˆå†™ï¼Ÿå¦‚ä½•ä½¿ç”¨ä¸¤ä¸ªä¿¡å·é‡å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…ï¼Ÿ"






## Notes on AI Assistance

- AI tools were used primarily for:
  - Troubleshooting build and compilation errors
  - Understanding xv6 system call mechanism
  - Implementing semaphore synchronization primitives
  - Debugging Makefile syntax issues
  - Writing documentation

- All code was tested and verified independently after AI assistance
- Understanding of the code was achieved through studying xv6 source code and documentation

---

## Author

**Kaidi Lyu**
University of South Carolina
*Operating Systems Project â€” xv6 Semaphore Extension*
