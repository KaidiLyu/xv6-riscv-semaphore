# xv6-riscv README

## Overview

xv6 is a modern re-implementation of Dennis Ritchie and Ken Thompson's **Unix Version 6 (v6)**. It follows the original structure and design philosophy of v6 but is re-written in **ANSI C** for the **RISC-V multiprocessor architecture**. xv6 is widely used as an educational operating system in MITâ€™s 6.1810 Operating Systems course.

This customized version extends the base xv6 with **semaphore synchronization primitives** and includes demonstration programs to verify inter-process communication and synchronization.

---

## New Features in This Project

### Semaphore System Calls

Newly implemented system calls for process synchronization:

| System Call           | Description                                 |
| --------------------- | ------------------------------------------- |
| `sem_init(int value)` | Initialize a semaphore with a given count   |
| `sem_wait(int id)`    | Wait (decrement), block if value <= 0       |
| `sem_post(int id)`    | Signal (increment), wake up waiting process |
| `sem_free(int id)`    | Free a semaphore and release resources      |

* Implemented in: `kernel/semaphore.c`
* Kernel linkage through: `sysproc.c`, `syscall.c`, `syscall.h`
* User-level interface: `user/semtest.c`, `user/prodcons.c`

---

## Demonstration Programs

### 1. **semtest.c**

A simple parent-child synchronization test:

* The child waits using `sem_wait()`.
* The parent releases it using `sem_post()`.

Expected Output:

```
Parent: waiting on semaphore...
Child: semaphore acquired!
```

### 2. **prodcons.c**

Implements the **Producer-Consumer problem** using semaphores:

* Ensures mutual exclusion and synchronization.
* Demonstrates inter-process communication.

Expected Output:

```
Producer: produced item 1
Consumer: consumed item 1
Producer finished!
Consumer finished!
All items processed!
```

---

## xv6 System Architecture Summary

For detailed system design and subsystem descriptions, refer to the accompanying documentation:
ðŸ“„ `System_Architecture.md`

Covers:

* Boot and initialization sequence
* Process scheduling (Round Robin)
* Memory management (Sv39 paging)
* File system structure (inode + journaling)
* System call mechanism and semaphore synchronization

---

## Build and Run Instructions

### 1. Install Dependencies (macOS / Linux)

```bash
brew install qemu riscv-tools
```

### 2. Build xv6 for RISC-V

```bash
make TOOLPREFIX=riscv64-unknown-elf-
```

### 3. Run xv6 in QEMU

```bash
make qemu TOOLPREFIX=riscv64-unknown-elf-
```

### 4. Inside xv6 Shell

To run demo programs:

```bash
$ semtest
$ prodcons
```

---

## Acknowledgments

xv6 is based on the work of:

* Dennis Ritchie and Ken Thompson (original Unix v6)
* MIT CSAIL PDOS group: Russ Cox, Frans Kaashoek, and Robert Morris

See the original xv6 distribution and documentation at:
[https://pdos.csail.mit.edu/6.1810/](https://pdos.csail.mit.edu/6.1810/)

---

## AI Tool Usage and Tips

This project was developed with the assistance of AI tools (ChatGPT). Below are tips used during development, categorized by type.

### Environment Setup and Installation

1. **macOS RISC-V Toolchain Installation**

- "I'm using macOS, please provide more instructions on how to install the riscv64-unknown-elf toolchain."

2. **Xcode Command Line Tools**

- "brew install gcc reports an error, requiring Xcode command line tools, what should I do?"

### Build System and Makefile Issues

3. **Makefile Syntax Errors**

- "Why does running make result in the error 'Command started before the first target'?"

- "Why does make qemu always fail? What could be the cause?"

- "Why does make indicate a missing delimiter?"

4. **File Paths and Locations**

- "Why can't exec run sleep.c?" Where should it be placed? - Why can't semtest execute? I've already added it to the Makefile.

### System Usage

5. **QEMU and Shell Navigation**

- How do I exit the xv6 shell? How do I return to the macOS terminal?

### Code Implementation and Debugging

6. **System Call Implementation**

- Which files need to be modified to add system calls?

- Why is sys_sleep being defined again? How should the code in syscall.c and sysproc.c be split?

- Why is there a "fetchstr/fetchaddr duplicate definition" error?

- Why is syscalls[] out of scope? How should it be numbered?

- Should sem_init/sem_wait/sem_post/sem_free be placed in syscall.c or sysproc.c?

7. **Semaphore Implementation**

- Why does semtest display "unknown"? Is this a system call?

- Why does `semaphore_wait` use a `while` loop? How should `sleep` and `wakeup` work correctly together?

- How to implement a properly blocking `semaphore_wait` in xv6?

8. **Program Output and Behavior**

- Why does `semtest` output garbled characters? Is there a problem with the `printf` function or the user program?

- Why is the output order of `prodcons` inconsistent? Is this normal?

9. **Producer-Consumer Implementation**

- How should `prodcons.c` be written? How to implement a producer-consumer relationship using two semaphores?

## Author

**Kaidi Lyu, Sessoms Carson**
University of South Carolina
*Operating Systems Project â€” xv6 Semaphore Extension*
